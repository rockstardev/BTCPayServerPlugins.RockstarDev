name: BTCPay Plugin tests

on:
    push:
        branches: [ "fixbug" ]
    pull_request:
        branches: [ "master" ]

jobs:
    build:
        
        runs-on: ubuntu-22.04
        env:
            CI: true
            BTCPAY_SERVER_URL: http://localhost:14142
        
        steps:
            -   uses: actions/checkout@v4
                with:
                    submodules: recursive

            -   name: Initialize and update submodules
                run: git submodule update --init --recursive

            -   name: Clean workspace
                run: |
                    dotnet clean
                    git clean -xfd

            -   name: Setup .NET
                uses: actions/setup-dotnet@v4
                with:
                    dotnet-version: 8.0.414

            -   name: Build solution
                run: |
                    dotnet build -maxcpucount:1

            -   name: Special commands - Running Config Builder to init plugins
                run: |
                    dotnet run --project ConfigBuilder
                    
            -   name: Install Playwright CLI + browsers
                run: |
                    dotnet tool install --global Microsoft.Playwright.CLI
                    export PATH="$PATH:$HOME/.dotnet/tools"
                    playwright install --with-deps

            -   name: Start Docker containers
                run: docker compose -f "submodules/btcpayserver/BTCPayServer.Tests/docker-compose.yml" up -d dev --build

            -   name: Run tests
                run: dotnet test BTCPayServer.Plugins.Tests --verbosity normal --filter "Category=PlaywrightUITest"

            -   name: Cleanup Docker
                run: docker compose -f submodules/btcpayserver/BTCPayServer.Tests/docker-compose.yml down --volumes
