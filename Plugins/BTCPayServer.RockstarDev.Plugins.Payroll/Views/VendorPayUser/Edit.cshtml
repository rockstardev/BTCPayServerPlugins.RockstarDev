@inject IScopeProvider ScopeProvider
@using BTCPayServer.Abstractions.Contracts
@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.Abstractions.Models
@using BTCPayServer.RockstarDev.Plugins.VendorPay.Views
@model VendorPayUserCreateViewModel
@{
	Layout = "_Layout";
	ViewData.SetLayoutModel(new LayoutModel(nameof(VendorPayNavPages.VendorPayUsers), "Edit Vendor Pay User")
	{ ActiveCategory = nameof(VendorPayNavPages) });
	var storeId = ScopeProvider.GetCurrentStoreId();

	bool IsValidReminderDate(string value)
	{
		if (string.IsNullOrWhiteSpace(value)) return false;
		if (int.TryParse(value, out var num)) return num >= 1 && num <= 31;
		return false;
	}

	var initialReminders = (Model.EmailReminder ?? "").Split(',')
		.Where(r => !string.IsNullOrWhiteSpace(r)).Select(r => r.Trim())
		.Where(IsValidReminderDate).Distinct()
		.OrderBy(r => int.Parse(r)).ToList();
}

<form method="post" asp-action="Edit">
	<div class="sticky-header d-flex align-items-center justify-content-between">
		<h2 class="mb-0">@ViewData["Title"]</h2>
		<input type="submit" value="Save Changes" class="btn btn-primary" id="Edit" />
	</div>

	<partial name="_StatusMessage" />

	<div class="row">
		<div class="col-md-6">
			<div class="form-group">
				<label asp-for="Name" class="form-label"></label>
				<input asp-for="Name" class="form-control" />
				<span asp-validation-for="Name" class="text-danger"></span>
			</div>
			<div class="form-group">
				<label asp-for="Email" class="form-label"></label>
				<input asp-for="Email" class="form-control" />
				<span asp-validation-for="Email" class="text-danger"></span>
			</div>
			<div class="form-group">
				<label asp-for="Password" class="form-label">Password</label>
				<div class="input-group">
					<input asp-for="Password" class="form-control" placeholder="***********" readonly />
					<div class="input-group-append">
						<a asp-controller="VendorPayUser" asp-action="ResetPassword" asp-route-userId="@Model.Id"
						   asp-route-storeId="@storeId" class="btn btn-secondary">Reset Password</a>
					</div>
				</div>
			</div>

			<div class="form-group">
				<label asp-for="EmailReminder" class="form-label"></label>
				<p class="text-muted small mb-2">Select reminder days. Day 31 also triggers on the last day of shorter months.</p>
				@if (!Model.StoreEmailSettingsConfigured)
				{
					<div class="text-warning small mt-1">Store Email Settings must be configured for reminders to work</div>
				}
				<div class="d-flex flex-wrap gap-1" id="dayGrid">
					@for (int d = 1; d <= 31; d++)
					{
						var isSelected = initialReminders.Contains(d.ToString());
						<button type="button" class="btn btn-sm @(isSelected ? "btn-primary" : "btn-outline-secondary") day-btn" data-day="@d">@d</button>
					}
				</div>
				<div class="small mt-2" style="min-height:1.2rem;">
					<span id="summaryText" class="text-muted"></span>
				</div>

				<input type="hidden" id="EmailReminder" asp-for="EmailReminder" value="@string.Join(",", initialReminders)" />
			</div>
		</div>
	</div>
</form>


@section PageFootContent {
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const hiddenInput = document.getElementById("EmailReminder");
			const summaryText = document.getElementById("summaryText");

			function getSelected() {
				return hiddenInput.value ? hiddenInput.value.split(",").map(Number).filter(Boolean) : [];
			}

			function setSelected(days) {
				const sorted = [...new Set(days)].filter(d => d >= 1 && d <= 31).sort((a, b) => a - b);
				hiddenInput.value = sorted.join(",");
				syncGrid(sorted);
				updateSummary(sorted);
			}

			function syncGrid(days) {
				document.querySelectorAll(".day-btn").forEach(btn => {
					const active = days.includes(parseInt(btn.dataset.day));
					btn.classList.toggle("btn-primary", active);
					btn.classList.toggle("btn-outline-secondary", !active);
				});
			}

			function updateSummary(days) {
				if (!days.length) {
					summaryText.textContent = "No days selected";
					return;
				}
				summaryText.innerHTML = `Reminders on day${days.length > 1 ? "s" : ""}: <strong>${days.join(", ")}</strong>`;
			}

			document.getElementById("dayGrid").addEventListener("click", function (e) {
				const btn = e.target.closest(".day-btn");
				if (!btn) return;
				const day = parseInt(btn.dataset.day);
				const current = getSelected();
				setSelected(current.includes(day) ? current.filter(d => d !== day) : [...current, day]);
			});

			updateSummary(getSelected());
		});
	</script>
}
