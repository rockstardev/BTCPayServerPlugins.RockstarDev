@model BTCPayServer.RockstarDev.Plugins.WalletHistoryReload.ViewModels.WalletHistoryReloadViewModel
@{
    ViewData["Title"] = "Wallet History Reload";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <h2>@ViewData["Title"]</h2>
            <p class="text-muted">Backfill missing transaction data (fees, rates, USD prices) from blockchain APIs</p>

            @if (Model.BackfillCompleted)
            {
                <div class="alert alert-success">
                    <h4>Backfill Completed</h4>
                    <p>Processed: <strong>@Model.ProcessedTransactions</strong> transactions</p>
                    <p>Failed: <strong>@Model.FailedTransactions</strong> transactions</p>
                </div>
            }

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Wallet Information</h5>
                    <dl class="row">
                        <dt class="col-sm-3">Wallet ID (BTCPayServer)</dt>
                        <dd class="col-sm-9"><code>@Model.WalletId</code></dd>
                        
                        <dt class="col-sm-3">Wallet ID (NBXplorer)</dt>
                        <dd class="col-sm-9"><code>@Model.NBXWalletId</code></dd>
                        
                        <dt class="col-sm-3">Total Transactions</dt>
                        <dd class="col-sm-9">@Model.TotalTransactions</dd>
                        
                        <dt class="col-sm-3">Missing Data</dt>
                        <dd class="col-sm-9">
                            <span class="badge bg-warning">@Model.MissingDataCount transactions</span>
                        </dd>
                    </dl>
                </div>
            </div>

            @if (Model.MissingDataCount > 0)
            {
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Backfill Options</h5>
                        <form method="post" asp-action="Preview" asp-route-storeId="@Model.StoreId" asp-route-cryptoCode="@Model.CryptoCode">
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" asp-for="IncludeFees" id="includeFees" checked />
                                <label class="form-check-label" for="includeFees">
                                    <strong>Fetch transaction fees and fee rates</strong> from Mempool.space API
                                </label>
                            </div>

                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" asp-for="IncludeHistoricalPrices" id="includeHistoricalPrices" checked />
                                <label class="form-check-label" for="includeHistoricalPrices">
                                    <strong>Fetch historical BTC/USD prices</strong> from CoinGecko API
                                </label>
                            </div>

                            <div class="alert alert-info">
                                <strong>Note:</strong> This will fetch data for <strong>@Model.MissingDataCount transactions</strong> with missing data. 
                                API rate limits are respected with a 500ms delay between requests. 
                                Estimated time: <strong>~@(Model.MissingDataCount * 0.5 / 60) minutes</strong>.
                                <br/><br/>
                                You will be able to preview the fetched data before saving it to the database.
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <i class="fa fa-download"></i> Fetch Data & Preview (@Model.MissingDataCount transactions)
                            </button>
                            <a asp-controller="UIStores" asp-action="Dashboard" asp-route-storeId="@Model.StoreId" class="btn btn-secondary">Cancel</a>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-success">
                    <strong>All transactions have complete data!</strong> No backfill needed.
                </div>
            }

            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Transactions with Missing Data (showing first 50)</h5>
                </div>
                <div class="card-body">
                    @{
                        var missingDataTransactions = Model.Transactions.Where(t => t.HasMissingData).ToList();
                    }
                    @if (missingDataTransactions.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Transaction</th>
                                        <th class="text-end">Amount</th>
                                        <th class="text-end">Transaction fee</th>
                                        <th class="text-end">Rate (USD)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var tx in missingDataTransactions.Take(50))
                                    {
                                        <tr class="table-warning">
                                            <td>@tx.Timestamp.ToString("M/d/yyyy, h:mm tt")</td>
                                            <td>
                                                @{
                                                    var mempoolUrl = Model.Network == "testnet" 
                                                        ? $"https://mempool.space/testnet/tx/{tx.TransactionId}"
                                                        : Model.Network == "signet"
                                                        ? $"https://mempool.space/signet/tx/{tx.TransactionId}"
                                                        : $"https://mempool.space/tx/{tx.TransactionId}";
                                                }
                                                <a href="@mempoolUrl" target="_blank" rel="noopener noreferrer">
                                                    <code class="small">@tx.TransactionId.Substring(0, 16)...</code>
                                                </a>
                                                @if (tx.IsConfirmed)
                                                {
                                                    <span class="badge bg-success ms-1">Confirmed</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary ms-1">Unconfirmed</span>
                                                }
                                            </td>
                                            <td class="text-end @(tx.BalanceChange >= 0 ? "text-success" : "text-danger")">
                                                @tx.BalanceChange.ToString("N8")
                                            </td>
                                            <td class="text-end">
                                                @if (tx.Fee.HasValue && tx.FeeRate.HasValue)
                                                {
                                                    <span>@tx.Fee.Value.ToString("N8") <small class="text-muted">(@tx.FeeRate.Value.ToString("N3") Sat/B)</small></span>
                                                }
                                                else if (tx.Fee.HasValue)
                                                {
                                                    <span>@tx.Fee.Value.ToString("N8") <span class="badge bg-warning ms-1">Rate Missing</span></span>
                                                }
                                                else if (tx.FeeRate.HasValue)
                                                {
                                                    <span class="badge bg-warning">Fee Missing</span> <small class="text-muted">(@tx.FeeRate.Value.ToString("N3") Sat/B)</small>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">Missing</span>
                                                }
                                            </td>
                                            <td class="text-end">
                                                @if (tx.RateUsd.HasValue)
                                                {
                                                    <span>@tx.RateUsd.Value.ToString("N2") USD</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-warning">Missing</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (missingDataTransactions.Count > 50)
                        {
                            <p class="text-muted mt-2">Showing 50 of @missingDataTransactions.Count transactions with missing data</p>
                        }
                    }
                    else
                    {
                        <p class="text-muted">All transactions have complete data!</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
