@using BTCPayServer.Abstractions.Contracts
@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.RockstarDev.Plugins.WalletSweeper.Data.Models
@inject IScopeProvider ScopeProvider
@{
    var storeId = ScopeProvider.GetCurrentStoreId();
    ViewData.SetActivePage("WalletSweeper", "Wallet Sweeper", "WalletSweeper");
    var config = ViewBag.Configuration as SweepConfiguration;
    var history = ViewBag.History as List<SweepHistory> ?? new List<SweepHistory>();
    var walletBalance = ViewBag.WalletBalance as decimal? ?? 0m;
    var isHotWallet = ViewBag.IsHotWallet as bool? ?? false;
    var hasWallet = ViewBag.HasWallet as bool? ?? false;
}

<div class="sticky-header-setup"></div>
<div class="sticky-header">
    <a class="unobtrusive-link">
        <h2 class="my-1">@ViewData["Title"]</h2>
        <div class="text-muted fw-semibold" data-sensitive>
            @walletBalance.ToString("N8") BTC
        </div>
    </a>
</div>

<partial name="_StatusMessage" />

<div class="row">
    <div class="col-xxl-constrain col-xl-10">
        
        @if (!hasWallet)
        {
            <!-- No Wallet Configured -->
            <div class="alert alert-danger">
                <h5><i class="fa fa-exclamation-triangle"></i> Bitcoin Wallet Not Configured</h5>
                <p class="mb-2">To use Wallet Sweeper, you need to set up a Bitcoin wallet for this store first.</p>
                <p class="mb-0">
                    <a asp-controller="UIStores" asp-action="SetupWallet" asp-route-storeId="@storeId" asp-route-cryptoCode="BTC" class="alert-link btn btn-danger">
                        <i class="fa fa-wallet"></i> Set Up Bitcoin Wallet
                    </a>
                </p>
            </div>
        }
        else if (config == null)
        {
            <!-- No Configuration -->
            <div class="alert alert-info">
                <h5><i class="fa fa-info-circle"></i> No Configuration Found</h5>
                <p class="mb-2">You haven't set up wallet sweeping for this store yet.</p>
                <p class="mb-0">
                    <a asp-action="Configure" asp-route-storeId="@storeId" class="alert-link">
                        Click here to create a sweep configuration
                    </a>
                </p>
            </div>
        }
        else
        {
            <!-- Configuration Status -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Sweep Configuration</h5>
                    <div class="d-flex gap-2">
                        @if (!isHotWallet && !string.IsNullOrEmpty(config.EncryptedSeed))
                        {
                            <!-- Cold wallet with seed - show modal trigger -->
                            <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#manualSweepModal" 
                                    title="Manually trigger a sweep (requires password for cold wallet)">
                                <i class="fa fa-bolt"></i> Trigger Sweep
                            </button>
                        }
                        else if (isHotWallet)
                        {
                            <!-- Hot wallet - direct submit -->
                            <form method="post" asp-action="TriggerManualSweep" asp-route-storeId="@storeId" class="d-inline">
                                <button type="submit" class="btn btn-sm btn-warning" title="Manually trigger a sweep">
                                    <i class="fa fa-bolt"></i> Trigger Sweep
                                </button>
                            </form>
                        }
                        else
                        {
                            <!-- Cold wallet without seed - disabled -->
                            <button type="button" class="btn btn-sm btn-warning" disabled 
                                    title="Configure seed phrase first to enable manual sweeps">
                                <i class="fa fa-bolt"></i> Trigger Sweep
                            </button>
                        }
                        <div class="vr"></div>
                        <a asp-action="Configure" asp-route-storeId="@storeId" class="btn btn-sm btn-secondary">
                            <i class="fa fa-edit"></i> Edit
                        </a>
                        <form method="post" asp-action="DeleteConfiguration" asp-route-storeId="@storeId" class="d-inline" 
                              onsubmit="return confirm('Are you sure you want to delete this configuration?');">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fa fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="mb-0">
                                <dt>Status</dt>
                                <dd>
                                    @if (config.Enabled)
                                    {
                                        <span class="badge bg-success">Enabled</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Disabled</span>
                                    }
                                </dd>
                                
                                <dt>Destination Address</dt>
                                <dd class="text-break"><code>@config.DestinationValue</code></dd>
                                
                                <dt>Balance Thresholds</dt>
                                <dd>
                                    Min: <strong>@config.MinimumBalance.ToString("N8") BTC</strong><br/>
                                    Max: <strong>@config.MaximumBalance.ToString("N8") BTC</strong><br/>
                                    Reserve: <strong>@config.ReserveAmount.ToString("N8") BTC</strong>
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="mb-0">
                                <dt>Sweep Interval</dt>
                                <dd>Every <strong>@config.IntervalDays</strong> day(s)</dd>
                                
                                <dt>Fee Rate</dt>
                                <dd><span class="badge bg-info">@config.FeeRate</span></dd>
                                
                                <dt>Last Sweep</dt>
                                <dd>
                                    @if (config.LastSweepDate.HasValue)
                                    {
                                        @config.LastSweepDate.Value.ToBrowserDate()
                                    }
                                    else
                                    {
                                        <em>Never</em>
                                    }
                                </dd>
                                
                                <dt>Created</dt>
                                <dd>@config.Created.ToBrowserDate()</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Sweep History -->
        @if (history.Any())
        {
            <h4 class="mb-3">Sweep History</h4>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Amount</th>
                            <th>Fee</th>
                            <th>Destination</th>
                            <th>Status</th>
                            <th>Trigger</th>
                            <th>TX</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in history)
                        {
                            <tr>
                                <td>@item.Timestamp.ToBrowserDate()</td>
                                <td>@item.Amount.ToString("N8") BTC</td>
                                <td>@item.Fee.ToString("N8") BTC</td>
                                <td class="text-truncate" style="max-width: 150px;">@item.Destination</td>
                                <td>
                                    @if (item.Status == SweepHistory.SweepStatuses.Success)
                                    {
                                        <span class="badge bg-success">Success</span>
                                    }
                                    else if (item.Status == SweepHistory.SweepStatuses.Failed)
                                    {
                                        <div>
                                            <span class="badge bg-danger">Failed</span>
                                            @if (!string.IsNullOrEmpty(item.ErrorMessage))
                                            {
                                                <br/><small class="text-danger">@item.ErrorMessage</small>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">Pending</span>
                                    }
                                </td>
                                <td>@item.TriggerType</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(item.TxId))
                                    {
                                        <a href="#" target="_blank" title="@item.TxId">
                                            @item.TxId.Substring(0, 8)...
                                        </a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

    </div>
</div>

<!-- Manual Sweep Password Modal (for cold wallets) -->
@if (!isHotWallet && config != null && !string.IsNullOrEmpty(config.EncryptedSeed))
{
    <div class="modal fade" id="manualSweepModal" tabindex="-1" aria-labelledby="manualSweepModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" asp-action="TriggerManualSweep" asp-route-storeId="@storeId">
                    <div class="modal-header">
                        <h5 class="modal-title" id="manualSweepModalLabel">
                            <i class="fa fa-bolt"></i> Manual Sweep - Password Required
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-warning">
                            <i class="fa fa-exclamation-triangle"></i> This is a cold wallet. Enter your encryption password to decrypt the seed and sign the transaction.
                        </div>
                        <div class="form-group">
                            <label for="seedPassword" class="form-label">Encryption Password</label>
                            <input type="password" class="form-control" id="seedPassword" name="seedPassword" 
                                   placeholder="Enter password" required autofocus />
                            @if (!string.IsNullOrEmpty(config.SeedPassphrase))
                            {
                                <small class="form-text text-muted">Hint: @config.SeedPassphrase</small>
                            }
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">
                            <i class="fa fa-bolt"></i> Execute Sweep
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}
