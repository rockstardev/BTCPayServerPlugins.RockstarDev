@using BTCPayServer.Abstractions.Contracts
@using BTCPayServer.Abstractions.Extensions
@using BTCPayServer.RockstarDev.Plugins.WalletSweeper.Data.Models
@inject IScopeProvider ScopeProvider
@{
    var storeId = ScopeProvider.GetCurrentStoreId();
    ViewData.SetActivePage("WalletSweeper", "Wallet Sweeper", "WalletSweeper");
    var config = ViewBag.Configuration as SweepConfiguration;
    var history = ViewBag.History as List<SweepHistory> ?? new List<SweepHistory>();
    var walletBalance = ViewBag.WalletBalance as decimal? ?? 0m;
    var isHotWallet = ViewBag.IsHotWallet as bool? ?? false;
}

<div class="sticky-header-setup"></div>
<div class="sticky-header">
    <a class="unobtrusive-link">
        <h2 class="my-1">@ViewData["Title"]</h2>
        <div class="text-muted fw-semibold" data-sensitive>
            @walletBalance.ToString("N8") BTC
        </div>
    </a>
</div>

<partial name="_StatusMessage" />

<div class="row">
    <div class="col-xxl-constrain col-xl-10">
        
        @if (config == null)
        {
            <!-- No Configuration -->
            <div class="alert alert-info">
                <h5><i class="fa fa-info-circle"></i> No Configuration Found</h5>
                <p class="mb-2">You haven't set up wallet sweeping for this store yet.</p>
                <p class="mb-0">
                    <a asp-action="Configure" asp-route-storeId="@storeId" class="alert-link">
                        Click here to create a sweep configuration
                    </a>
                </p>
            </div>
        }
        else
        {
            <!-- Configuration Status -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Sweep Configuration</h5>
                    <div class="d-flex gap-2">
                        <form method="post" asp-action="TriggerManualSweep" asp-route-storeId="@storeId" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-warning" @(config.Enabled ? "" : "disabled")>
                                <i class="fa fa-bolt"></i> Trigger Sweep
                            </button>
                        </form>
                        <div class="vr"></div>
                        <a asp-action="Configure" asp-route-storeId="@storeId" class="btn btn-sm btn-secondary">
                            <i class="fa fa-edit"></i> Edit
                        </a>
                        <form method="post" asp-action="DeleteConfiguration" asp-route-storeId="@storeId" class="d-inline" 
                              onsubmit="return confirm('Are you sure you want to delete this configuration?');">
                            <button type="submit" class="btn btn-sm btn-danger">
                                <i class="fa fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="mb-0">
                                <dt>Status</dt>
                                <dd>
                                    @if (config.Enabled)
                                    {
                                        <span class="badge bg-success">Enabled</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Disabled</span>
                                    }
                                </dd>
                                
                                <dt>Destination Address</dt>
                                <dd class="text-break"><code>@config.DestinationValue</code></dd>
                                
                                <dt>Balance Thresholds</dt>
                                <dd>
                                    Min: <strong>@config.MinimumBalance.ToString("N8") BTC</strong><br/>
                                    Max: <strong>@config.MaximumBalance.ToString("N8") BTC</strong><br/>
                                    Reserve: <strong>@config.ReserveAmount.ToString("N8") BTC</strong>
                                </dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl class="mb-0">
                                <dt>Sweep Interval</dt>
                                <dd>Every <strong>@config.IntervalDays</strong> day(s)</dd>
                                
                                <dt>Fee Rate</dt>
                                <dd><span class="badge bg-info">@config.FeeRate</span></dd>
                                
                                <dt>Last Sweep</dt>
                                <dd>
                                    @if (config.LastSweepDate.HasValue)
                                    {
                                        @config.LastSweepDate.Value.ToBrowserDate()
                                    }
                                    else
                                    {
                                        <em>Never</em>
                                    }
                                </dd>
                                
                                <dt>Created</dt>
                                <dd>@config.Created.ToBrowserDate()</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        }

        <!-- Sweep History -->
        @if (history.Any())
        {
            <h4 class="mb-3">Sweep History</h4>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Amount</th>
                            <th>Fee</th>
                            <th>Destination</th>
                            <th>Status</th>
                            <th>Trigger</th>
                            <th>TX</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in history)
                        {
                            <tr>
                                <td>@item.Timestamp.ToBrowserDate()</td>
                                <td>@item.Amount.ToString("N8") BTC</td>
                                <td>@item.Fee.ToString("N8") BTC</td>
                                <td class="text-truncate" style="max-width: 150px;">@item.Destination</td>
                                <td>
                                    @if (item.Status == SweepHistory.SweepStatuses.Success)
                                    {
                                        <span class="badge bg-success">Success</span>
                                    }
                                    else if (item.Status == SweepHistory.SweepStatuses.Failed)
                                    {
                                        <span class="badge bg-danger" title="@item.ErrorMessage">Failed</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-warning">Pending</span>
                                    }
                                </td>
                                <td>@item.TriggerType</td>
                                <td>
                                    @if (!string.IsNullOrEmpty(item.TxId))
                                    {
                                        <a href="#" target="_blank" title="@item.TxId">
                                            @item.TxId.Substring(0, 8)...
                                        </a>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

    </div>
</div>
