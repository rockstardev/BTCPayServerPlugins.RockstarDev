@model BTCPayServer.Models.InvoicingModels.CheckoutModel
@inject MarkPaidMethodsRegistry Registry
@inject Safe Safe

@foreach (var m in Registry.Methods)
{
    var component = MarkPaidUi.ComponentNameFor(m);
    <text>
        <template id="@component">
            <div>
                <a class="btn btn-primary rounded-pill w-100 mt-4" href="#" v-on:click.prevent="markAsPaid">Mark Settled</a>
            </div>
        </template>
        <script>
            Vue.component(@Safe.Json(component), {
                props: ['model'],
                template: @Safe.Json("#" + component),
                data() {
                    return {isProcessing: false};
                },
                mounted() {
                    const method = this.model.paymentMethodId;
                    const observer = new MutationObserver(() => {
                        const h4 = document.querySelector('#settled h4');
                        if (h4 && h4.textContent === 'Invoice Paid') {
                            h4.textContent = `Invoice Settled - ${method}`;
                        }
                    });
                    observer.observe(document.getElementById('Checkout'), {childList: true, subtree: true});
                },
                methods: {
                    async markAsPaid() {
                        if (this.isProcessing) return;
                        this.isProcessing = true;
                        const response = await fetch(this.model.invoiceBitcoinUrl, {
                            method: 'POST',
                            headers: {'X-Requested-With': 'RockstarHttpRequester'}
                        });
                        if ((await response.json()).success) {
                            
                        }

                        this.isProcessing = false;
                    }
                }
            });
        </script>
    </text>
}

<!-- Update settled title to show payment method -->
<!-- Runs globally because settled view doesn't render payment method components -->
<script>
    window.updateSettledTitle = () => {
        const h4 = document.querySelector('#settled h4');
        if (h4 && h4.textContent === 'Invoice Paid') {
            const method = window.location.pathname.split('/').pop();
            if (method && method !== 'i') h4.textContent = `Invoice Settled - ${method}`;
        }
    };
    
    const observer = new MutationObserver(window.updateSettledTitle);
    observer.observe(document.getElementById('Checkout'), {childList: true, subtree: true});
    setTimeout(window.updateSettledTitle, 100);
</script>
